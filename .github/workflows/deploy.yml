name: Deploy con Diagnostico
on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Diagnostico y Reemplazo
        run: |
          echo "--- REVISANDO ARCHIVOS ---"
          ls -R
          
          echo "--- PROBANDO SECRETO (No se mostrara el valor real) ---"
          if [ -z "${{ secrets.FLOW_HISTORIAL_REGISTROS }}" ]; then
            echo "ERROR: El secreto FLOW_HISTORIAL_REGISTROS esta vacio o no existe en Settings"
            exit 1
          fi

          echo "--- EJECUTANDO REEMPLAZO ---"
          # Usamos un comando mas agresivo
          sed -i 's|FLOW_HISTORIAL_REGISTROS|${{ secrets.FLOW_HISTORIAL_REGISTROS }}|g' index.js
          
          echo "--- VERIFICANDO SI LA PALABRA SIGUE AHI ---"
          if grep -q "FLOW_HISTORIAL_REGISTROS" index.js; then
            echo "ERROR: La palabra no se pudo reemplazar"
            exit 1
          else
            echo "EXITO: La palabra fue reemplazada en index.js"
          fi

      - name: Deploy a GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: .
          branch: gh-pages
